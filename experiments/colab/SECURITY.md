# 🔒 セキュリティ・プライバシー仕様書

## 概要

この深度推定APIは、ユーザーのプライバシーと画像データの安全性を最優先に設計されています。

## 🛡️ セキュリティ機能

### 1. データ保護

#### ✅ 画像の非永続化
- **一時処理のみ**: 画像はメモリ内でのみ処理され、ディスクに保存されません
- **即座削除**: 処理完了後、画像データは明示的にメモリから削除されます
- **ファイル保存なし**: 中間ファイルや一時ファイルは作成されません

#### ✅ メモリ管理
- **自動クリーンアップ**: 各リクエスト後にガベージコレクション実行
- **GPU メモリクリア**: CUDA使用時は自動的にGPUメモリをクリア
- **セッション管理**: タイムアウト機能でメモリリークを防止

### 2. ログ保護

#### ✅ 画像データ除外
- **フィルタリング**: Base64画像データはログに出力されません
- **長い文字列除外**: 1000文字以上の文字列はログから自動除外
- **構造化ログ**: セキュリティイベントのみ記録

#### ✅ プライバシーログ
```python
# 安全なログ例
INFO - 🖼️ Image processed: 1024x768px
INFO - ✅ Request completed successfully: 1234567890
ERROR - ❌ Image size too large: max 2048px allowed
```

### 3. 入力検証

#### ✅ 画像サイズ制限
- **最大サイズ**: 2048px × 2048px
- **メモリ保護**: 大きすぎる画像は処理前に拒否
- **リソース保護**: GPU/CPUリソースの適切な使用

#### ✅ ファイル形式検証
- **対応形式**: JPEG, PNG, WebP のみ
- **セキュリティチェック**: 不正なファイルの検出
- **エラーハンドリング**: 安全な例外処理

### 4. API セキュリティ

#### ✅ Gradio設定
- **フラグ機能無効**: `allow_flagging="never"`
- **アナリティクス無効**: `analytics_enabled=False`
- **デバッグモード無効**: `debug=False`
- **API仕様非表示**: `show_api=False`

#### ✅ セッション管理
- **一意ID**: 各リクエストにユニークセッションID
- **タイムアウト**: 1時間でセッション自動終了
- **状態追跡**: 処理状態の安全な管理

## 🚨 セキュリティ警告

### ❌ 避けるべき使用方法

1. **機密画像の処理**
   - 個人情報が含まれる画像
   - 企業秘密や特許関連画像
   - 医療画像や生体認証データ

2. **大量処理**
   - バッチ処理や自動化
   - 商用利用での大量アクセス
   - DoS攻撃的な使用

3. **ネットワーク経由の機密データ**
   - VPN非使用での機密データ送信
   - 公共Wi-Fi経由でのアクセス

## 🔧 セキュリティ設定

### 環境変数設定
```bash
# セキュリティ強化設定
GRADIO_ANALYTICS_ENABLED=False
GRADIO_DEBUG=False
LOGGING_LEVEL=INFO
MAX_IMAGE_SIZE=2048
SESSION_TIMEOUT=3600
```

### ngrok セキュリティ
```python
# ngrok認証トークン設定
ngrok.set_auth_token("your_secure_token")

# HTTPS強制
public_url = ngrok.connect(7860, proto="http", bind_tls=True)
```

## 📊 セキュリティ監査

### ログ監視項目
- 異常なファイルサイズ
- 連続エラー発生
- セッションタイムアウト
- メモリ使用量異常

### アラート条件
```python
# 監視対象
- 画像サイズ > 2048px
- セッション時間 > 3600秒  
- 連続エラー > 5回
- メモリ使用量 > 80%
```

## 🔄 インシデント対応

### 1. セキュリティ侵害時
1. **即座停止**: サーバーを緊急停止
2. **ログ確認**: セキュリティログの確認
3. **メモリクリア**: 残存データの完全削除
4. **再起動**: クリーンな状態で再起動

### 2. 異常検知時
1. **自動クリーンアップ**: メモリとセッションの強制クリア
2. **ログ記録**: 異常イベントの詳細記録
3. **アクセス制限**: 必要に応じて一時的なアクセス制限

## ✅ コンプライアンス

### データ保護規則への対応
- **GDPR**: 個人データの非保存・即座削除
- **CCPA**: 消費者プライバシー権の尊重
- **日本個人情報保護法**: 適切な技術的安全管理措置

### 推奨事項
1. **利用規約の明示**: プライバシーポリシーの表示
2. **同意取得**: 画像処理に対するユーザー同意
3. **データ最小化**: 必要最小限のデータ処理
4. **透明性**: セキュリティ機能の明確な説明

## 🔍 技術詳細

### メモリ管理コード例
```python
def cleanup_session(self, session_id):
    """完全なセッションクリーンアップ"""
    if session_id in self.processing_sessions:
        del self.processing_sessions[session_id]
    
    # Python ガベージコレクション
    gc.collect()
    
    # GPU メモリクリア
    if torch.cuda.is_available():
        torch.cuda.empty_cache()
    
    # 明示的な変数削除
    locals().clear()
```

### セキュアな画像処理
```python
def secure_image_processing(self, image_data):
    """セキュアな画像処理"""
    try:
        # 処理実行
        result = self.process_image(image_data)
        return result
    finally:
        # 確実なデータ削除
        del image_data
        gc.collect()
```

---

**⚠️ 重要**: このセキュリティ仕様は継続的に更新されます。最新版を定期的に確認してください。